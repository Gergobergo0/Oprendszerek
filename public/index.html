<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Streaming demo</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 0;
        padding: 1rem;
        background: #111;
        color: #f5f5f5;
      }
      h1 {
        margin-bottom: 0.5rem;
      }
      #status {
        font-size: 0.9rem;
        margin-bottom: 1rem;
      }
      #events {
        font-family: monospace;
        white-space: pre-wrap;
        background: #1e1e1e;
        padding: 1rem;
        border-radius: 8px;
        max-height: 80vh;
        overflow-y: auto;
      }
      .event {
        border-bottom: 1px solid #333;
        padding-bottom: 0.75rem;
        margin-bottom: 0.75rem;
      }
    </style>
  </head>
  <body>
    <h1>DB ->  Kafka -> WebSocket demo</h1>
    <div id="status">Connecting…</div>
    <div id="events"></div>

    <script>
      const statusEl = document.getElementById("status");
      const eventsEl = document.getElementById("events");

      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const wsUrl = protocol + "//" + window.location.host + "/ws";
      const ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        statusEl.textContent = "Connected to WebSocket";
      };

      ws.onclose = () => {
        statusEl.textContent = "Disconnected (refresh to retry)";
      };

      ws.onerror = (err) => {
        console.error("WebSocket error", err);
        statusEl.textContent = "️WebSocket error";
      };

      ws.onmessage = (msg) => {
        let data;
        try {
          data = JSON.parse(msg.data);
        } catch {
          data = { raw: msg.data };
        }

        // Expect Debezium-style { value: { before: {...}, after: {...} } }
        const v = data.value || {};
        const before = v.before ?? null;
        const after = v.after ?? null;

        const container = document.createElement("div");
        container.className = "event";

        const header = document.createElement("div");
        header.textContent =
          "Topic: " +
          (data.topic || "(unknown)") +
          " | offset " +
          (data.offset || "?");

        const body = document.createElement("pre");
        body.textContent = JSON.stringify(
          { before, after, raw: v },
          null,
          2
        );

        container.appendChild(header);
        container.appendChild(body);

        // prepend newest on top
        eventsEl.insertBefore(container, eventsEl.firstChild);
      };
    </script>
  </body>
</html>
